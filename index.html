<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Summarizer for Turkish Expats</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-3xl border border-gray-200">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">Haber Analiz ve Özetleme Aracı</h1>
        <p class="text-gray-600 text-center mb-6">Türk expat'lar için haber başlığı, özeti, kategorisi ve değer puanı almak için bir haber linki girin.</p>

        <!-- Input and button container -->
        <div class="flex flex-col sm:flex-row items-center gap-4 mb-6">
            <input 
                type="url" 
                id="urlInput" 
                class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full" 
                placeholder="Örnek: https://www.bbc.com/turkce/haberler-..."
            />
            <button 
                id="summarizeBtn" 
                class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200"
            >
                Analiz Et
            </button>
        </div>

        <!-- Result area -->
        <div id="resultContainer" class="hidden">
            <div id="loadingIndicator" class="hidden text-center">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-blue-500 border-gray-200 rounded-full"></div>
                <p class="mt-2 text-gray-600">Analiz ediliyor...</p>
            </div>
            <div id="summaryOutput" class="space-y-4">
                <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <p class="font-bold text-lg text-gray-800">Başlık:</p>
                    <p id="titleOutput" class="text-gray-700 mt-1"></p>
                </div>
                <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <p class="font-bold text-lg text-gray-800">Özet:</p>
                    <p id="summaryTextOutput" class="text-gray-700 mt-1 leading-relaxed break-words"></p>
                </div>
                <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <p class="font-bold text-lg text-gray-800">Haber Kategorisi:</p>
                    <p id="categoryOutput" class="text-gray-700 mt-1"></p>
                </div>
                <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <p class="font-bold text-lg text-gray-800">Türk Expat'lar İçin Değeri:</p>
                    <p id="expatValueOutput" class="text-gray-700 mt-1"></p>
                </div>
            </div>
            <div id="errorOutput" class="hidden p-4 mt-4 bg-red-100 text-red-700 rounded-lg">
                <!-- Error messages will be displayed here -->
            </div>
        </div>
    </div>

    <script>
        // API key will be provided by the canvas environment.
        const apiKey = ""; 

        // Get DOM elements
        const urlInput = document.getElementById('urlInput');
        const summarizeBtn = document.getElementById('summarizeBtn');
        const resultContainer = document.getElementById('resultContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorOutput = document.getElementById('errorOutput');
        
        // New elements for the updated outputs
        const summaryOutput = document.getElementById('summaryOutput');
        const titleOutput = document.getElementById('titleOutput');
        const summaryTextOutput = document.getElementById('summaryTextOutput');
        const categoryOutput = document.getElementById('categoryOutput');
        const expatValueOutput = document.getElementById('expatValueOutput');

        // Event listener for the button click
        summarizeBtn.addEventListener('click', async () => {
            const url = urlInput.value.trim();

            // Validate URL input
            if (!url) {
                showError("Lütfen geçerli bir URL girin.");
                return;
            }

            // Show loading state and hide previous results
            resultContainer.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            summaryOutput.classList.add('hidden');
            errorOutput.classList.add('hidden');
            
            // The prompt for the LLM. We are asking for a structured JSON response.
            const promptText = `
                You are an expert news summarizer and media analyst specialized in expat-relevant content. Given the URL below, perform the following tasks in Turkish and respond in a structured JSON format:
                1. Generate a concise title for the article, no more than 6-7 words.
                2. Write a concise summary of the article in 3 sentences, focusing on key takeaways for Turkish expats.
                3. Categorize the article into one of the following categories: 'Siyaset', 'Politika', 'Dünya Gündemi', 'Avrupa Gündemi', 'Ekonomi', 'Expat', 'Diğer'.
                4. Rate the value of the article for Turkish expats on a scale of 1-10.
                5. Explain the reason for this rating in one sentence.
                The link is: ${url}
            `;

            try {
                // Prepare the payload for the Gemini API call with a structured response schema
                const payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: promptText }]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "title": { "type": "STRING" },
                                "summary": { "type": "STRING" },
                                "category": { "type": "STRING" },
                                "expatValueScore": { "type": "NUMBER" },
                                "reasonForScore": { "type": "STRING" }
                            },
                            "propertyOrdering": ["title", "summary", "category", "expatValueScore", "reasonForScore"]
                        }
                    }
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=AIzaSyAYR9EZRf5DwzzJPpEUMZl5NnIa0TcNCgM`;

                let response;
                let retryCount = 0;
                const maxRetries = 3;
                let delay = 1000;

                // Exponential backoff for API calls
                while (retryCount < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            break; // Success, exit the retry loop
                        } else if (response.status === 429) {
                            // Too many requests, retry with exponential backoff
                            console.log(`Rate limit exceeded. Retrying in ${delay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Double the delay
                            retryCount++;
                        } else {
                            // Other errors, throw to be caught below
                            throw new Error(`API error: ${response.status} ${response.statusText}`);
                        }
                    } catch (err) {
                        if (retryCount < maxRetries - 1) {
                            console.error(`Fetch error: ${err}. Retrying...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                            retryCount++;
                        } else {
                            throw err; // Last retry failed, re-throw the error
                        }
                    }
                }

                if (!response || !response.ok) {
                    throw new Error("API'den yanıt alınamadı veya başarısız oldu.");
                }

                const result = await response.json();
                const jsonText = result.candidates[0].content.parts[0].text;
                const parsedJson = JSON.parse(jsonText);

                // Display the structured summary
                titleOutput.textContent = parsedJson.title;
                summaryTextOutput.textContent = parsedJson.summary;
                categoryOutput.textContent = parsedJson.category;
                expatValueOutput.textContent = `${parsedJson.expatValueScore}/10 - ${parsedJson.reasonForScore}`;
                
                summaryOutput.classList.remove('hidden');

            } catch (error) { 
                console.error("Hata:", error);
                showError("Analiz oluşturulurken bir hata oluştu. Lütfen URL'yi kontrol edin veya daha sonra tekrar deneyin.");
            } finally {
                // Hide loading indicator
                loadingIndicator.classList.add('hidden');
            }
        });

        function showError(message) {
            loadingIndicator.classList.add('hidden');
            errorOutput.textContent = message;
            errorOutput.classList.remove('hidden');
            summaryOutput.classList.add('hidden');
            resultContainer.classList.remove('hidden');
        }
    </script>
</body>
</html>





